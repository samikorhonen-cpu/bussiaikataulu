<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bussiaikataulu</title>

<!-- iPad fullscreen -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<style>
    body {
        margin: 0;
        background: black;
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #container {
        padding: 40px;
    }

    #stop {
        font-size: 48px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 40px;
    }

    .card {
        display: flex;
        align-items: center;
        border: 4px solid #444;
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 30px;
    }

    .line {
        flex: 1;
        font-size: 88px;
        font-weight: bold;
    }

    .time {
        flex: 1;
        font-size: 88px;
        text-align: center;
        font-weight: bold;
    }

    .delay {
        flex: 1;
        font-size: 64px;
        text-align: right;
        font-weight: bold;
    }

    .ok { color: #00ff00; }
    .warn { color: #ffcc00; }
    .bad { color: #ff4444; }
</style>
</head>

<body>
<div id="container">
    <div id="stop">Ladataanâ€¦</div>
    <div id="cards"></div>
</div>

<script>
const STOP_ID = "HSL:2132245"; // Trillakatu
const API_KEY = "0f78f242bf544ab1af1549eb047efc6e";
const API_URL = "https://api.digitransit.fi/routing/v2/hsl/gtfs/v1";

async function loadData() {
    const query = `
    {
      stop(id: "${STOP_ID}") {
        name
        stoptimesWithoutPatterns(numberOfDepartures: 5) {
          serviceDay
          scheduledDeparture
          realtimeDeparture
          departureDelay
          trip { route { shortName } }
        }
      }
    }`;

    const res = await fetch(API_URL, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "digitransit-subscription-key": API_KEY
        },
        body: JSON.stringify({ query })
    });

    const json = await res.json();
    if (!json.data) return;

    document.getElementById("stop").textContent = json.data.stop.name;

    const now = new Date();
    const cards = document.getElementById("cards");
    cards.innerHTML = "";

    let shown = 0;

    for (const d of json.data.stop.stoptimesWithoutPatterns) {
        if (shown >= 3) break;

        const depSec = d.realtimeDeparture ?? d.scheduledDeparture;
        const depTime = new Date((d.serviceDay + depSec) * 1000);

        if (depTime < now) continue;

        const delayMin = Math.round((d.departureDelay || 0) / 60);
        let cls = "ok";
        if (delayMin > 2) cls = "warn";
        if (delayMin > 5) cls = "bad";

        cards.innerHTML += `
            <div class="card">
                <div class="line ${cls}">${d.trip.route.shortName}</div>
                <div class="time ${cls}">
                    ${depTime.toLocaleTimeString("fi-FI", {hour: "2-digit", minute: "2-digit"})}
                </div>
                <div class="delay ${cls}">
                    ${delayMin > 0 ? "+" + delayMin + " min" : ""}
                </div>
            </div>
        `;
        shown++;
    }
}

loadData();
setInterval(loadData, 30000);
</script>
</body>
</html>
